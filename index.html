<!--
ページ読込直後は、glbモデル非表示。
クリック・タップ・VRゴーグルのトリガーでstartExperience発生＆BGM再生。
BGMを3秒再生したらモデル表示＆anime01を3.966秒だけ再生（移動なし）。
anime01を3.966秒表示したら、anime02を2回再生しながら(0,-0.8,-6)→(0,-0.8,-2)へ移動＆sound02再生。
anime02終了後、anime03を3回再生しながらsound03再生（移動なし）。
sound03を17.5秒再生後、anime04を3回再生しながらsound04再生（移動なし）。
anime04再生後、https://seiei.ac.jp/ へ遷移。
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GLB Multiple Animations in A-Frame</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- animation-mixerコンポーネントを明示的にインポート -->
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene>
    <!-- Controller -->
    <a-entity laser-controls="hand: left" raycaster="objects: .collidable; far: 4; color: #ffcccc"></a-entity>
    <a-entity laser-controls="hand: right" raycaster="objects: .collidable; far: 4; color: #ccffcc"></a-entity>

    <!-- 最初は非表示(visible="false")にしておく -->
    <a-entity
      id="myModel"
      gltf-model="./EntranceGuide.glb"
      position="0,-0.8,-6"
      scale="1.5 1.5 1.5"
      visible="false"
    ></a-entity>
    
    <!-- 360度画像の背景 -->
    <a-sky id="sky" src="R0010034.JPG" rotation="0 0 0"></a-sky>
    
    <!-- 音声エンティティ -->
    <a-entity id="bgm" sound="src: url(bgm01.mp3); autoplay: false; loop: true;"></a-entity>
    <a-entity id="sound1" sound="src: url(sound01.mp3); autoplay: false; loop: true;"></a-entity>
    <a-entity id="sound2" sound="src: url(sound02.mp3); autoplay: false; loop: false;"></a-entity>
    <a-entity id="sound3" sound="src: url(sound03.mp3); autoplay: false; loop: true;"></a-entity>
    <a-entity id="sound4" sound="src: url(sound04.mp3); autoplay: false; loop: false;"></a-entity>
    
    <!-- カメラとカーソル -->
    <a-entity camera look-controls>
      <a-entity cursor="fuse: false"
                position="0 -1.5 -1"
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: white; shader: flat">
      </a-entity>
    </a-entity>
  </a-scene>
  
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('loaded', function () {
        console.log('A-Frameシーンが読み込まれました。VRモードに切り替えます。');
        if (sceneEl.enterVR) {
          sceneEl.enterVR();
        }
      });

      const modelEl = document.getElementById('myModel');
      const bgmEl = document.getElementById('bgm');
      const sound2El = document.getElementById('sound2');
      const sound3El = document.getElementById('sound3');
      const sound4El = document.getElementById('sound4');

      let hasStarted = false;

      modelEl.addEventListener('model-loaded', function () {
        console.log('モデルが正常に読み込まれました（非表示状態）');
        console.log('version 1.0.6');
      });

      document.addEventListener('click', startExperience, { once: true });
      sceneEl.addEventListener('triggerdown', startExperience, { once: true });

      function startExperience() {
        if (hasStarted) return;
        hasStarted = true;

        console.log('ユーザーアクションを検出しました。BGMを開始します。');
        bgmEl.components.sound.playSound();

        // 3秒後にモデル表示＆anime01開始
        setTimeout(function() {
          console.log('3秒経過。モデル表示＆anime01開始');
          modelEl.setAttribute('visible', true);
          modelEl.setAttribute('position', '0 -0.8 -6');
          modelEl.setAttribute('animation-mixer', {
            clip: 'anime01',
            loop: 'false',
            repetitions: '1',
            timeScale: '1',
            clampWhenFinished: 'true'
          });

          // anime01を3.966秒表示したらanime02へ
          setTimeout(function () {
            console.log('anime02開始（2回繰り返し＆移動＆sound02再生）');
            modelEl.setAttribute('animation-mixer', {
              clip: 'anime02',
              loop: 'false',
              repetitions: '2',
              timeScale: '1',
              clampWhenFinished: 'true'
            });
            // (0,-0.8,-6)→(0,-0.8,-2)へ移動
            modelEl.setAttribute('animation__position', 'property: position; to: 0 -0.8 -2; dur: 9200; easing: easeInSine; loop: false');
            sound2El.components.sound.playSound();

            // anime02(2回=4.6秒×2=9.2秒)終了後にanime03へ
            setTimeout(function () {
              sound2El.components.sound.stopSound();
              console.log('anime03開始（3回繰り返し＆sound03再生）');
              modelEl.setAttribute('animation-mixer', {
                clip: 'anime03',
                loop: 'false',
                repetitions: '3',
                timeScale: '1',
                clampWhenFinished: 'true'
              });
              sound3El.components.sound.playSound();

              // sound03を17.5秒再生後、anime04を3回再生しながらsound04再生
              setTimeout(function () {
                sound3El.components.sound.stopSound();
                console.log('anime04開始（3回繰り返し＆sound04再生）');
                modelEl.setAttribute('animation-mixer', {
                  clip: 'anime04',
                  loop: 'false',
                  repetitions: '3',
                  timeScale: '1',
                  clampWhenFinished: 'true'
                });
                sound4El.components.sound.playSound();

                // anime04(3回分)終了後に自動的にページ遷移
                setTimeout(function () {
                  window.location.href = 'https://seiei.ac.jp/';
                }, 3167 * 3); // anime04(3回分)
              }, 17500); // sound03の再生時間
            }, 4600 * 2); // anime02(2回分)
          }, 3966); // anime01を3.966秒表示
        }, 3000); // BGM3秒後
      }
    });
  </script>
</body>
</html>